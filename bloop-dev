#!/bin/bash

set -e

cross_setup() {

	    cd /tmp/
	    wget -c https://releases.linaro.org/components/toolchain/binaries/6.5-2018.12/arm-linux-gnueabihf/gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf.tar.xz
	    if [ $? -ne 0 ]; then
	    	echo "Failure to get arm-linux-gnueabihf"
	    fi
	    sudo tar xf gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf.tar.xz -C /opt/

	    rm gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf.tar.xz
} &> /dev/null

gtest_setup() {
	BB_TOOLCHAIN=$PWD/toolchains/beaglebone.cmake
	cd /usr/src/gtest
	if [ "$1" == "cross" ]; then
	    sudo rm -rf ARM && sudo mkdir ARM
	    cd ARM
	    sudo cmake -DCMAKE_TOOLCHAIN_FILE=$BB_TOOLCHAIN .. -B .
	    sudo make
	else
	    sudo cmake .
	    sudo make
        fi
} &> /dev/null

picklerick() {

    cat <<'EOF'
        ___
    . -^   `--,      
   /# =========`-_   
  /# (--====___====\ 
 /#   .- --.  . --.| 
/##   |  * ) (   * ),
|##   \    /\ \   / |
|###   ---   \ ---  |
|####      ___)    #|
|######           ##|
 \##### ---------- / 
  \####           (  
   `\###          |  
     \###         |  
      \##        |   
       \###.    .)   
        `======/
EOF
}

if [ $# -eq 0 ]; then
    echo "Usage $0 {clean, build}"
    exit 1
fi


if [ "$1" == "build" ]; then
    export GLIB_PATH="libgtest.a"
    if [ ! -e '/usr/src/gtest/libgtest.a' ]; then
	echo 'setting up gtest...'
        $(gtest_setup)
    fi

    $0 clean
    mkdir build && cd build
    cmake ..
    make
    picklerick


elif [ "$1" == "cross" ]; then
    export GLIB_PATH="ARM/libgtest.a"
    if [ ! -d /opt/gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf ]; then
	echo 'setting up cross compiler...'
        $(cross_setup)
    fi

    if [ ! -e '/usr/src/gtest/ARM/libgtest.a' ]; then
	echo 'setting up gtest...'
        $(gtest_setup cross)
    fi

    $0 clean
    mkdir build && cd build
    cmake -DCMAKE_TOOLCHAIN_FILE=./toolchains/beaglebone.cmake ..
    make
    picklerick


elif [ "$1" == "clean" ]; then
	rm -rf build
	rm -rf out
	rm -rf coverage
	echo "clean finished"
fi
